# OSDA (Operating System Deployment Automation)

Contains 2 sources:
-- OSDA_BETA_3.0.4: source code of OSDA
-- osda-ansible: ansible playbooks to call OSDA API and provision server and install OS

## Install OSDA on CentOS 7.8

```bash
# Install the prerequisite
yum update -y
yum install -y mkisofs xorriso kpartx python3-setuptools httpd python3 python3-pip lsof git
pip3 install hpOneView
pip3 install hpeOneView==5.5.0 (optional)

# Install OSDA
git clone https://github.com/tdovan/osda.git
cd osda/src/OSDA_BETA_3.0.4
chmod 755 update_osda.sh
./update_osda.sh
> enter the ip of your vm
it does
> python3 setup.py install
> systemctl daemon-reload
> systemctl restart osda
> systemctl status osda

lsof -i :5000
lsof -i :80

chmod 755 configureWeb.sh
./configureWeb.sh
# open the port on the firewall
firewall-cmd --list-all
firewall-cmd --add-port=5000/tcp --permanent
firewall-cmd --add-port=80/tcp --permanent
systemctl reload firewalld

you're done: go to http://osda

```

## Install ansible playbook to use OSDA

```bash
yum install epel-release -y
yum install ansible -y
cd osda/src/osda-ansible
edit the data/deploy.json (to add your ESXi configuration - refer to the example of json template)

ipaddr=$(/sbin/ifconfig|grep inet|head -1|sed 's/\:/ /'|awk '{print $2}' | grep -v '127.0.0.1')
sed -i 's/<osda_ip_address/$ipaddr/' inventory/host_vars/OSDA.yml

ansible-playbook -e ansible_python_interpreter=/usr/bin/python3 -i inventory/OSDA osda_deploy_server.yml

```

## File directory

| Path | Description |
| --- | --- |
| /opt/hpe/osda/bin | binary |
| /opt/hpe/osda/data/activities | logs of activities |
| /opt/hpe/osda/data/certs | certifcate of oneview retrieve when endpoint added |
| /opt/hpe/osda/data/config | configuration of OSDA |
| /opt/hpe/osda/data/kickstarts | list of kickstart |
| /opt/hpe/osda/data/scratch | init config |
| /opt/hpe/osda/etc/config.ini | configuration of OSDA |
| /opt/hpe/osda/lib | python library |
| /opt/hpe/osda/log/OSDA | main log file |
| /var/www/html/ | http repo for ISO and IMG(ks) mounted by USB Virtual Media |

## Tips

```bash
# to mount a img generated by OSDA
to monitor the logs
tail -f /opt/hpe/osda/log/OSDA

# to mount a img generated by OSDA
fdisk -lu /tmp/1.img
mount -t auto -o loop,offset=$((2048*512)) /tmp/1.img /mnt/img/

```

```json
# Template of json file
{
  "taskName": "1-node",
  "hosts": [
    {
      "serverProfile": "<OV-ServerProfile>",
      "hostName": "<ESXI-hostname>",
      "osPackage": "<Name of the ESXi ISO>",
      "kickstartFile": "<Name of the ks>",
      "networks": [
        {
          "ipAddr": "<ip>",
          "netmask": "<netmask>",
          "gateway": "<gateway>",
          "dns": "<dns>",
          "bootProto": "static",
          "nic1": {
            "connectionName": "<ov-connection>"
          },
          "nic2": {
            "connectionName": ""
          },
          "bondingType": "",
          "vlans": ""
        },
        {}
      ],
      "osDrive": {
        "driveName": "<OV-InstallationDriveName>"
      }
    }
  ],
  "deploymentMode": "hpesynergy",
  "createServerProfile": true,
  "oneviewDetails": {
    "ovName": "<OV-Name in SODA>",
    "ovSPT": "<OV-ServerProfileTemplate>"
  }
}
``
